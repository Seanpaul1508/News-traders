name: News Traders CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, 3.10, 3.11]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Display Python version
      run: |
        echo "üêç Using Python version:"
        python --version

    - name: Project structure verification
      run: |
        echo "üìÅ PROJECT STRUCTURE"
        echo "===================="
        find . -name "*.py" -type f | head -15
        echo ""
        echo "üìä KEY FILES CHECK"
        echo "=================="
        [ -f "requirements.txt" ] && echo "‚úÖ requirements.txt" || echo "‚ùå requirements.txt"
        [ -f "src/news_analyzer.py" ] && echo "‚úÖ src/news_analyzer.py" || echo "‚ùå src/news_analyzer.py"
        [ -f "src/trading_engine.py" ] && echo "‚úÖ src/trading_engine.py" || echo "‚ùå src/trading_engine.py"
        [ -f "src/sentiment_analysis.py" ] && echo "‚úÖ src/sentiment_analysis.py" || echo "‚ùå src/sentiment_analysis.py"

    - name: Install dependencies
      run: |
        echo "üì¶ INSTALLING DEPENDENCIES"
        echo "=========================="
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo ""
        echo "‚úÖ INSTALLED PACKAGES"
        pip list

    - name: Core functionality tests
      run: |
        echo "üß™ CORE FUNCTIONALITY TESTS"
        echo "==========================="
        
        echo "1. Testing basic Python..."
        python -c "print('‚úÖ Basic Python working')"
        
        echo "2. Testing data analysis imports..."
        python -c "import pandas as pd; import numpy as np; print('‚úÖ Pandas/Numpy imported')"
        
        echo "3. Testing ML imports..."
        python -c "import sklearn; import nltk; print('‚úÖ Scikit-learn/NLTK imported')"
        
        echo "4. Testing API imports..."
        python -c "import requests; import flask; print('‚úÖ Requests/Flask imported')"
        
        echo "5. Testing financial imports..."
        python -c "import yfinance; import pandas_datareader; print('‚úÖ Financial libraries imported')"

    - name: News trading module tests
      run: |
        echo "üì∞ NEWS TRADING MODULE TESTS"
        echo "============================"
        python -c "
try:
    # Test if core modules can be imported
    from src.news_analyzer import NewsAnalyzer
    print('‚úÖ NewsAnalyzer imported successfully')
    
    from src.trading_engine import TradingEngine  
    print('‚úÖ TradingEngine imported successfully')
    
    from src.sentiment_analysis import SentimentAnalyzer
    print('‚úÖ SentimentAnalyzer imported successfully')
    
    print('üéâ All core news trading modules imported!')
    
except ImportError as e:
    print(f'‚ùå Import error: {e}')
except Exception as e:
    print(f'‚ö†Ô∏è  Other error: {e}')
"

    - name: Run unit tests
      run: |
        echo "üî¨ RUNNING UNIT TESTS"
        echo "====================="
        if [ -d "tests" ]; then
          python -m pytest tests/ -v
        else
          echo "No tests directory found, skipping unit tests"
        fi

    - name: Code quality check
      run: |
        echo "üìù CODE QUALITY CHECKS"
        echo "======================"
        pip install pylint black
        echo "Python files:"
        find . -name "*.py" -not -path "./venv/*" | head -10
        
        # Basic syntax check on all Python files
        python -m py_compile src/*.py && echo "‚úÖ All Python files compile successfully"

  deployment:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Deploy readiness check
      run: |
        echo " üöÄ DEPLOYMENT READINESS CHECK"
        echo "=============================="
        python -c "
import sys
import os
sys.path.append('src')

try:
    # Test the entire application stack
    from news_analyzer import NewsAnalyzer
    from trading_engine import TradingEngine
    from sentiment_analysis import SentimentAnalyzer
    
    print('‚úÖ All application modules loaded')
    print('‚úÖ News Traders system ready for deployment')
    
    # Test basic functionality
    analyzer = NewsAnalyzer()
    print('‚úÖ NewsAnalyzer instantiated')
    
except Exception as e:
    print(f'‚ùå Deployment check failed: {e}')
    sys.exit(1)
"
